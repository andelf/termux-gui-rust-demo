# Termux:GUI Rust Demo 故障排查指南

## 常见问题速查表

| 症状 | 可能原因 | 解决方案 |
|------|---------|---------|
| 编译失败 | 不在 HOME 目录 | `cd ~ && 重新编译` |
| Permission denied | 文件没有执行权限 | `chmod +x target/release/termux-gui-rust-demo` |
| 连接超时 | 插件未安装/未运行 | 安装 Termux:GUI 插件 |
| 一闪而过 | 自动退出太快 | 使用等待模式（默认） |
| 黑屏/无界面 | Activity 创建失败 | 查看错误日志 |

---

## 详细故障排查

### 1. 编译问题

#### 问题：`Permission denied (os error 13)`

```
error: failed to run custom build command for `serde_json v1.0.145`
Caused by: Permission denied (os error 13)
```

**原因**: 在非可执行目录编译（如 `/storage/emulated/0`）

**解决**:
```bash
# 检查当前目录
pwd

# 如果不在 HOME，移动项目
mv /storage/emulated/0/Documents/termux-gui-rust-demo ~/

# 进入 HOME 目录重新编译
cd ~/termux-gui-rust-demo
cargo clean
cargo build --release
```

#### 问题：编译时间过长或卡住

**解决**:
```bash
# 清理缓存重试
cargo clean
cargo build --release

# 如果还是很慢，检查网络
ping -c 3 crates.io

# 使用国内镜像（可选）
cat >> ~/.cargo/config.toml << 'EOF'
[source.crates-io]
replace-with = 'ustc'

[source.ustc]
registry = "https://mirrors.ustc.edu.cn/crates.io-index"
EOF
```

---

### 2. 运行时问题

#### 问题：`paths must not contain interior null bytes`

```
Error: Error { kind: InvalidInput, message: "paths must not contain interior null bytes" }
```

**原因**: 使用了旧版本代码，没有使用 `bind_abstract_socket`

**解决**:
```bash
# 确保代码已更新
cd ~/termux-gui-rust-demo
git pull  # 如果是 git 仓库
# 或重新下载最新代码

# 重新编译
cargo build --release
```

#### 问题：连接超时

```
Socket已绑定，等待连接...
（长时间无响应）
```

**原因**: Termux:GUI 插件未安装或未运行

**解决步骤**:

1. **检查插件是否安装**:
```bash
pm list packages | grep termux.gui
```
应该看到: `package:com.termux.gui`

2. **如果未安装**:
- 从 F-Droid 下载: https://f-droid.org/packages/com.termux.gui/
- 或从 GitHub Releases: https://github.com/termux/termux-gui/releases

3. **重启 Termux**:
```bash
exit
# 重新打开 Termux
```

4. **检查插件权限**:
- 打开 Android 设置
- 应用管理 → Termux:GUI
- 确保所有权限已授予

#### 问题：Activity 创建失败

```
Error: "无法获取Activity ID"
```

**调试步骤**:

1. **查看详细输出**:
```bash
cd ~/termux-gui-rust-demo
./target/release/termux-gui-rust-demo 2>&1 | tee debug.log
cat debug.log
```

2. **检查返回值**:
看 "接收消息" 行，应该是 `[数字, 数字]` 格式

3. **测试 Python 版本**:
```bash
pip install termuxgui
python3 << 'EOF'
import termuxgui as tg
with tg.Connection() as c:
    a = tg.Activity(c)
    print(f"Activity ID: {a.aid}")
EOF
```

如果 Python 版本也失败，说明是插件问题。

#### 问题：界面一闪而过

**原因**: 程序运行在自动模式或主线程退出太快

**解决**:
```bash
# 使用等待模式（默认）
./target/release/termux-gui-rust-demo

# 或使用自动模式但延长时间（需修改代码）
AUTO_MODE=1 ./target/release/termux-gui-rust-demo
```

**临时解决**（不关闭 Activity）:
修改代码，注释掉关闭 Activity 的部分。

---

### 3. 显示问题

#### 问题：黑屏或空白

**可能原因**:
1. TextView 创建失败
2. Activity 没有正确显示
3. 文本颜色与背景相同

**调试**:
```bash
# 查看完整日志
./target/release/termux-gui-rust-demo 2>&1 | tee full.log

# 检查是否有 "TextView创建成功" 消息
grep "TextView" full.log
```

**尝试修改文本**:
编辑 `src/main.rs`，修改文本内容：
```rust
"text": "Hello World from Rust! 🦀\n\nTEST TEST TEST"
```

#### 问题：中文显示乱码

**解决**:
```bash
# 检查终端编码
locale

# 应该看到 UTF-8
# 如果不是，设置：
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8
```

---

### 4. 事件处理问题

#### 问题：没有收到事件

**检查**:
```bash
# 运行程序并观察输出
./target/release/termux-gui-rust-demo

# 应该看到类似输出：
# 📨 收到事件: {"type":"create",...}
# 📨 收到事件: {"type":"start",...}
# 📨 收到事件: {"type":"resume",...}
```

**如果没有事件输出**:
- Event Socket 可能连接失败
- 查看是否有 "✓ Event Socket 已连接" 消息

#### 问题：程序不响应关闭

**原因**: 事件循环可能卡住

**解决**:
```bash
# 强制终止
Ctrl+C

# 或在另一个终端
pkill termux-gui-rust-demo
```

---

### 5. 性能问题

#### 问题：启动很慢

**可能原因**:
1. Debug 模式编译
2. 系统资源不足

**解决**:
```bash
# 确保使用 release 模式
ls -lh target/release/termux-gui-rust-demo

# 如果文件不存在或很大（>2MB），重新编译
cargo build --release

# release 版本应该约 750KB
```

#### 问题：内存占用高

**正常值**: ~3MB

**检查**:
```bash
# 运行程序后，在另一个终端
ps aux | grep termux-gui-rust-demo

# VSZ 列显示虚拟内存，RSS 列显示实际内存
```

**如果超过 10MB**: 可能是 debug 模式或内存泄漏

---

## 环境检查清单

运行以下命令检查环境：

```bash
#!/bin/bash

echo "=== Termux:GUI 环境检查 ==="
echo ""

echo "1. 检查 Rust 环境:"
rustc --version 2>&1 || echo "❌ Rust 未安装"
cargo --version 2>&1 || echo "❌ Cargo 未安装"
echo ""

echo "2. 检查 Termux:GUI 插件:"
if pm list packages | grep -q termux.gui; then
    echo "✅ Termux:GUI 已安装"
else
    echo "❌ Termux:GUI 未安装"
fi
echo ""

echo "3. 检查项目位置:"
pwd
if [[ $(pwd) == /data/data/com.termux/files/home* ]]; then
    echo "✅ 在 HOME 目录"
else
    echo "⚠️  不在 HOME 目录，可能导致权限问题"
fi
echo ""

echo "4. 检查编译产物:"
if [ -f ~/termux-gui-rust-demo/target/release/termux-gui-rust-demo ]; then
    echo "✅ 二进制文件存在"
    ls -lh ~/termux-gui-rust-demo/target/release/termux-gui-rust-demo
else
    echo "❌ 二进制文件不存在，需要编译"
fi
echo ""

echo "5. 检查权限:"
if [ -x ~/termux-gui-rust-demo/target/release/termux-gui-rust-demo ]; then
    echo "✅ 可执行权限正确"
else
    echo "❌ 缺少可执行权限"
fi
echo ""

echo "=== 检查完成 ==="
```

保存为 `check_env.sh` 并运行：
```bash
chmod +x check_env.sh
./check_env.sh
```

---

## 获取帮助

### 查看日志

```bash
# 完整日志
./target/release/termux-gui-rust-demo 2>&1 | tee debug.log

# 详细错误跟踪
RUST_BACKTRACE=full ./target/release/termux-gui-rust-demo 2>&1 | tee debug.log
```

### 对比 Python 版本

如果 Rust 版本有问题，尝试 Python 版本：

```bash
pip install termuxgui

python3 << 'EOF'
import termuxgui as tg
import time

with tg.Connection() as c:
    a = tg.Activity(c)
    tv = tg.TextView(a, "Python Test")
    time.sleep(3)
EOF
```

如果 Python 版本正常，说明问题在 Rust 实现。  
如果 Python 版本也失败，说明是插件或系统问题。

### 重置项目

```bash
cd ~/termux-gui-rust-demo
cargo clean
cargo build --release
./target/release/termux-gui-rust-demo
```

---

## 已知问题

### 1. Android 版本兼容性

- **最低要求**: Android 7.0 (API 24)
- **推荐**: Android 10+ (API 29+)

### 2. 权限问题

某些 Android 设备可能限制 Termux 的后台运行或显示悬浮窗。

**解决**:
- 设置 → 应用管理 → Termux
- 允许后台运行
- 允许显示在其他应用上层

### 3. 插件版本

确保使用最新版本的 Termux:GUI 插件。

**检查版本**:
```bash
pm dump com.termux.gui | grep versionName
```

---

## 调试技巧

### 1. 逐步调试

在代码中添加更多 `println!` 语句：

```rust
println!("DEBUG: 准备发送消息");
send_message(&mut main_stream, &activity_msg)?;
println!("DEBUG: 消息已发送");

let response = read_message(&mut main_stream)?;
println!("DEBUG: 收到响应: {:?}", response);
```

### 2. 使用 strace（高级）

```bash
# 跟踪系统调用
strace -e trace=socket,bind,connect,sendto,recvfrom \
    ./target/release/termux-gui-rust-demo 2>&1 | tee strace.log
```

### 3. 检查 socket 连接

```bash
# 运行程序后，在另一个终端
# 查看抽象命名空间 socket
ss -x | grep termux
```

---

## 报告问题

如果以上方法都无法解决问题，准备以下信息：

1. **系统信息**:
```bash
uname -a
getprop ro.build.version.release
```

2. **Rust 版本**:
```bash
rustc --version
cargo --version
```

3. **插件版本**:
```bash
pm dump com.termux.gui | grep versionName
```

4. **完整日志**:
```bash
RUST_BACKTRACE=full ./target/release/termux-gui-rust-demo 2>&1 > full.log
```

---

**最后更新**: 2025  
**状态**: 持续维护
